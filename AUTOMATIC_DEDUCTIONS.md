# Автоматическое списание ингредиентов

## Как это работает

Автоматическое списание ингредиентов происходит на уровне базы данных через триггеры PostgreSQL.

### Процесс:

1. **При создании заказа** - ингредиенты НЕ списываются
2. **При изменении статуса заказа на `COMPLETED`** - срабатывает триггер `trg_orders_after_update`, который:
   - Автоматически создает запись о продаже (sale)
   - Списывает ингредиенты из склада согласно рецептам блюд (dish_ingredients)
   - Проверяет достаточность запасов перед списанием
   - Предотвращает отрицательные остатки

### Триггеры в БД:

- `trg_orders_after_update` - обрабатывает завершение заказа
- `trg_supplies_after_update` - обрабатывает подтверждение поставки (добавляет ингредиенты на склад)
- `fn_update_order_total` - автоматически пересчитывает сумму заказа при изменении позиций

### Проверка доступности блюд:

Функция `fn_check_dish_available(p_dish_id, p_quantity)` проверяет, достаточно ли ингредиентов на складе для приготовления блюда.

### Безопасность:

- Используется `FOR UPDATE` для блокировки строк и предотвращения race conditions
- Проверка достаточности запасов перед списанием
- Исключение при недостаточном количестве ингредиентов

